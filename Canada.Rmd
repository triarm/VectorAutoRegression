---
title: "Beijing Air Quality"
author: "Tria Rahmat Mauludin"
date: "4/19/2022"
output: 
  html_document:
    theme: yeti
    highlight: tango
    df_print: paged
    toc: true
    toc_float: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# clear-up the environment
rm(list = ls())
```

# Background

Time Series adalah sekumpulan data yang dikumpulkan berdasarkan urutan waktu. Data Time Series dapat kita gunakan untuk memahami pola yang terjadi di masa lalu dan melakukan suatu *forecasting* atau peramalan suatu nilai di masa depan.

Salah satu bentuk dari time series adalah **Multivariate Time Series** yaitu data time series yang memiliki lebih dari satu variabel dan setiap variabel tersebut tidak hanya bergantung pada nilai di masa lalunya saja namun juga bergantung dengan nilai variabel lainnya. Salah satu contohnya adalah temperatur dan tekanan udara. Nilai temperatur tidak hanya dipengaruhi oleh nilainya di masa lampau namun dapat dipengaruhi juga oleh nilai tekanan udara. Hal yang sama dapat terjadi pula untuk sebaliknya. Pada artikel ini akan dibahas bagaimana membangun model Multivariate Time Series menggunakan **Vector Autoregressive (VAR)**.

# Vector Autoregressive (VAR)

Model VAR adalah generalisasi dari model univariate autoregressive (model AR dengan satu variabel). Dalam model VAR kita akan membangun persamaan untuk setiap variabel yang akan membentuk suatu sistem persamaan. Kita notasikan $y_{1,t}$ adalah nilai variabel $y_{1}$ pada observasi ke-*t* dan $y_{2,t}$ adalah nilai variabel $y_{2}$ pada observasi ke-*t*, dan seterusnya. Sebelum membangun model VAR, kita perlu menentukan terlebih dahulu banyaknya variabel yang akan digunakan (dinotasikan sebagai $K$) dan banyaknya lag (dinotasikan sebagai $p$) yang akan terlibat dalam sistem VAR. Misalkan kita memiliki VAR yang terdiri dari dua buah variabel dengan satu lag. Maka kita peroleh $VAR(1)$ dengan persamaan:

$$
y_{1,t} = c_{1} + \phi_{11}y_{1,t-1} + \phi_{12}y_{2,t-1} + e_{1,t}\\
y_{2,t} = c_{2} + \phi_{21}y_{1,t-1} + \phi_{22}y_{2,t-1} + e_{2,t}
$$

Sistem persamaan di atas dapat kita tuliskan juga dalam notasi matriks berikut

$$
\begin{bmatrix}
  y_{1,t} \\
  y_{2,t}
\end{bmatrix} = 
\begin{bmatrix}
  c_{1} \\
  c_{2}
\end{bmatrix} + 
\begin{bmatrix}
  \phi_{11} & \phi_{12} \\
  \phi_{21} & \phi_{22}
\end{bmatrix}
\begin{bmatrix}
  y_{1,t-1} \\
  y_{2,t-1}
\end{bmatrix} + 
\begin{bmatrix}
  e_{1,t} \\
  e_{2,t}
\end{bmatrix}
$$

# Import Library

Untuk mengimplementasikan VAR di R, kita akan menggunakan package `vars`. Selain itu, kita akan menggunakan beberapa package lainnya untuk melakukan preprocessing data, visualisasi data, serta evaluasi model.

```{r, warning=FALSE, message=FALSE}
library(dplyr)
library(padr)
library(lubridate)
library(forecast)
library(ggplot2)
library(MLmetrics)
library(lmtest)
library(vars)
```

# Read Data

Kita akan menggunakan data `dongsi.csv` berikut yang merupakan data terkait kualitas udara di subdistrict Dongsi, Beijing. Deskripsi lebih lanjut dari data dapat dilihat pada [link berikut](https://archive.ics.uci.edu/ml/datasets/Beijing+Multi-Site+Air-Quality+Data)

```{r}
Canada %>% autoplot(facets = TRUE)
```


# Exploratory Data Analysis

Pertama, kita lihat terlebih dahulu visualisasi pada masing-masing kolom.

```{r}
Canada[, c("prod", "rw")]
```
Perhatikan bahwa pada kolom `TEMP` dan `PRES` terjadi hubungan yang cukup kuat. Ketika nilai `TEMP` meningkat maka nilai `PRES` cenderung menurun dan begitu pula untuk sebaliknya. Untuk mengetahui hubungan apakah nilai dari suatu variabel di masa lampau dapat memengaruhi variabel lainnya di masa depan, kita dapat menggunakan uji **Granger Causality Test**. Untuk melakukan uji tersebut, kita dapat menggunakan fungsi `grangertest` dari package `lmtest`

```{r}
grangertest(dongsi$TEMP, dongsi$PRES)
```

> Diperoleh bahwa nilai p-values < 0.05 maka dapat disimpulkan bahwa variabel TEMP di masa lampau dapat digunakan untuk memprediksi nilai PRES di masa depan

Kita juga perlu menguji apakah hal sebaliknya dapat berlaku, yaitu apakah variabel PRES dapat digunakan untuk memprediksi nilai TEMP di masa depan

```{r}
grangertest(dongsi$PRES, dongsi$TEMP)
```

> Diperoleh bahwa nilai p-values < 0.05 maka dapat disimpulkan variabel PRES dapat digunakan untuk memprediksi nilai TEMP di masa depan

Berdasarkan hasil di atas, maka kita dapat membangun model multivariate time series yang terdiri dari dua buah variabel yaitu TEMP dan PRES.

# Modeling

Pertama, kita buat kolom `TEMP` dan `PRES` menjadi object time series.

```{r}
data_ts <- Canada[, c("prod", "rw", "e")]
data_ts %>% autoplot(facets = TRUE)
```

Lakukan spliting data train dan data test

```{r}
n_train <- as.integer(0.8*nrow(data_ts))
train_data <- head(data_ts, n_train)
test_data <- tail(data_ts, -n_train)
```

Pada package vars, terdapat fungsi `VARselect` yang dapat digunakan untuk mencari lag yang menghasilkan model dengan performa yang paling baik. Parameter `lag.max` menunjukkan nilai maksimum lag yang akan dicari dan `season` menunjukkan seasonality pada data.

```{r}
VARselect(train_data, lag.max = 10, season = 4)
```

Dengan melihat nilai AIC pada output di atas, diperoleh bahwa model VAR(5) merupakan model yang terbaik dibandingkan dengan lag lainnya. Maka langkah selanjutnya adalah membangun model tersebut dengan fungsi `VAR`

```{r}
model_5 <- VAR(train_data, p=3, season = 4)
```

# Forecasting

Setelah memperoleh model, maka kita akan menggunakan model tersebut untuk melakukan forecasting sebanyak data pada `test_data`

```{r}
prediction <- forecast(model_5, h = nrow(test_data))
```

Mari kita visualisasikan hasil forecasting dan membandingkannya dengan nilai pada `test_data`

```{r}
# plot TEMP
train_data[,"prod"] %>% 
  autoplot(main = "Productivity Rate") +
  autolayer(test_data[,"prod"], series = "Test Data") +
  autolayer(prediction$forecast$prod$mean, series = "Forecast")
```

```{r}
# Plot PRES
train_data[,"rw"] %>% autoplot(main = "Wage") +
  autolayer(test_data[,"rw"], series = "Test Data") +
  autolayer(prediction$forecast$rw$mean, series = "Forecast")
```

```{r}
# Plot PRES
train_data[,"e"] %>% autoplot(main = "Employment Rate") +
  autolayer(test_data[,"e"], series = "Test Data") +
  autolayer(prediction$forecast$e$mean, series = "Forecast")
```

Dari visualisasi di atas, dapat kita lihat bahwa hasil forecast sudah mengikuti pola dari nilai aktualnya. Untuk memeriksa lebih lanjut, mari kita lihat nilai MAPE dari kedua variabel tersebut.

```{r}
MAPE(prediction$forecast$prod$mean, test_data[,"prod"])*100
MAPE(prediction$forecast$rw$mean, test_data[,"rw"])*100
MAPE(prediction$forecast$e$mean, test_data[,"e"])*100
```


```{r}
cbind(prediction$forecast$rw$mean, test_data[,"rw"])
```

```{r}
serial.test(model_5)
```

```{r}
arch.test(model_5, multivariate.only = TRUE)
```

```{r}
causality(model_5, cause = "prod")
```

```{r}
causality(model_5, cause = "rw")
```

```{r}
irf(model_5, impulse = "prod", response = "rw", n.ahead = 20, boot = TRUE) %>% plot(ylab = "rw")
```

```{r}
irf(model_5, impulse = "rw", response = "prod", boot = TRUE) %>% plot(ylab = "rw")
```

